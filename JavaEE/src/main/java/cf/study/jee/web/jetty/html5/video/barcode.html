<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>BarCode</title>
<link href="/res/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<script type="text/javascript" src="/res/jquery-2.1.1.js"></script>
<script type="text/javascript" src="/res/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="quagga.js"></script>
<style>
	.vd {
		width: 640px;
		height: 480px;
		margin-left: -320px;
	}
	
	
	@media(max-width: 640px) {
		.vd {
			width: 480px;
			height: 320px;
			margin-left: -240px;
		}
	}
	@media (max-width: 480px), (max-width: 320px) {
		.vd {
			width: 320px;
			height: 320px;
			margin-left: -160px;
		}
	}
	
	.vd_center {
		position: absolute;
		left: 50%;
	}
	
	.footer {
	  position: absolute;
	  bottom: 0;
	  width: 100%;
	  height: 60px;
	  background-color: #f5f5f5;
	}
</style>
</head>

<body>
	<article class="container-fluid viewport" id="interactive">
		<video autoplay class="vd vd_center"></video>
	</article>

	<footer class="footer container">
		<p>decoded: <a id="result"></a></p>
	</footer>
	
	<script type="text/javascript">
		var ctx = {
			init : function() {
				Quagga.init(this.state, this.onError);
				Quagga.onProcessed(this.onProcessed);
				Quagga.onDetected(this.onDetected);
			},
			state: {
				inputStream: {
					type: "LiveStream",
					constraints: {
						//width: 640, height: 480
						facing: "environment"
					}
				},
				locator: {
					patchSize: "medium", halfSample: true
				},
				numOfWorkers: 4,
				decoder: {
					readers: ["ean_reader"]
				}, 
				locate: true
			},
			onError: function(err) {
				console.error(err);
			},
			onProcessed: function(result) {
				var drawingCtx = Quagga.canvas.ctx.overlay;
				var drawingCanvas = Quagga.cavas.dom.overlay;
				
				console.info(result);
				if (!result) return;
				
				if (result.boxes) {
					drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
					result.boxes.filter(function(box) {return box !== result.box;})
						.forEach(function(box){
							Quagga.ImageDebug.drawPath(box, {x:0, y:1}, drawingCtx, {color:"green", lineWidth: 2});
						});
				}
				
				if (result.box) {
					Quagga.ImageDebug.drawPath(box, {x:0, y:1}, drawingCtx, {color:"green", lineWidth: 2});
				}
				
				if (result.codeResult && result.codeResult.code) {
					Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
				}
			},
			onDetected: function(result) {
				var code = result.codeResult.code;
				var reElement = $("#result");
				reElement.text(code);
			}
		}
	
		function main() {
			ctx.init();
		}
		
		$(main);
	</script>
</body>
</html>